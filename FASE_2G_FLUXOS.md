# Fase 2G - ConfluenceEngine: FLUXOS DETALHADOS

## ğŸ“Š Ãndice de Fluxos

1. [Fluxo Principal de GeraÃ§Ã£o de Sinais](#fluxo-principal)
2. [Fluxo de Scoring de TendÃªncia](#fluxo-trend-score)
3. [Fluxo de Scoring de Momentum](#fluxo-momentum-score)
4. [Fluxo de DeterminaÃ§Ã£o de DireÃ§Ã£o](#fluxo-direction)
5. [Fluxo de Scan em Lote](#fluxo-scan-batch)
6. [Fluxo de Risco/Recompensa](#fluxo-risk-reward)
7. [Endpoints e IntegraÃ§Ãµes](#endpoints-integracao)

---

## ğŸ”„ Fluxo Principal de GeraÃ§Ã£o de Sinais {#fluxo-principal}

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  CLIENT REQUEST                                             â”‚
â”‚  POST /api/signals/generate/PETR4?days=30&minConfidence=60  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                         â”‚
                         â–¼ (JWT Token Validation)
                â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                â”‚ authMiddleware     â”‚
                â”‚ âœ“ Token valid?     â”‚
                â”‚ âœ“ User authorized? â”‚
                â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                         â”‚
                    â–¼ (YES)
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚ Validate Input                â”‚
        â”‚ - ticker: "PETR4"             â”‚
        â”‚ - days: 30                    â”‚
        â”‚ - minConfidence: 60 (0-100?)  â”‚
        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                     â”‚
                â–¼ (VALID)
     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
     â”‚ Step 1: Fetch Historical Data    â”‚
     â”‚                                  â”‚
     â”‚ MarketService.getHistoricalDaily â”‚
     â”‚ (ticker: "PETR4", days: 30)      â”‚
     â”‚                                  â”‚
     â”‚ â†’ Candle[] (30-90 elementos)    â”‚
     â”‚   â”œâ”€ 2025-01-01: O=100, H=102   â”‚
     â”‚   â”œâ”€ 2025-01-02: O=101, H=103   â”‚
     â”‚   â””â”€ 2025-01-14: O=102, H=105   â”‚
     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                  â”‚
            â–¼ (SUCCESS)
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚ Step 2: Calculate Indicators       â”‚
    â”‚                                    â”‚
    â”‚ IndicatorService.calculateAll()    â”‚
    â”‚                                    â”‚
    â”‚ â†’ Returns:                         â”‚
    â”‚  â”œâ”€ ema: {                         â”‚
    â”‚  â”‚   ema9: IndicatorValue[30]     â”‚
    â”‚  â”‚   ema21: IndicatorValue[30]    â”‚
    â”‚  â”‚   ema200: IndicatorValue[30]   â”‚
    â”‚  â”œâ”€ sma: {                         â”‚
    â”‚  â”‚   sma50: IndicatorValue[30]    â”‚
    â”‚  â”‚   sma200: IndicatorValue[30]   â”‚
    â”‚  â”œâ”€ rsi: {rsi: IndicatorValue[30]}â”‚
    â”‚  â”œâ”€ macd: {                        â”‚
    â”‚  â”‚   macd: IndicatorValue[30]     â”‚
    â”‚  â”‚   signal: IndicatorValue[30]   â”‚
    â”‚  â”‚   histogram: IndicatorValue[30]â”‚
    â”‚  â”œâ”€ atr: {atr: IndicatorValue[30]}â”‚
    â”‚  â”œâ”€ obv: {obv: IndicatorValue[30]}â”‚
    â”‚  â””â”€ vwap: {vwap: IndicatorValue[]}â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                 â”‚
          â–¼ (SUCCESS)
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚ Step 3: Type Adapter               â”‚
    â”‚                                    â”‚
    â”‚ adaptIndicatorsToConfluence()       â”‚
    â”‚                                    â”‚
    â”‚ Extract LAST values from arrays:   â”‚
    â”‚ â”œâ”€ ema9: 98.50 (scalar)            â”‚
    â”‚ â”œâ”€ ema21: 99.20 (scalar)           â”‚
    â”‚ â”œâ”€ ema200: 97.80 (scalar)          â”‚
    â”‚ â”œâ”€ sma50: 99.50 (scalar)           â”‚
    â”‚ â”œâ”€ sma200: 98.20 (scalar)          â”‚
    â”‚ â”œâ”€ rsi14: 65 (scalar)              â”‚
    â”‚ â”œâ”€ macd: {                         â”‚
    â”‚ â”‚   macd: 0.85 (scalar)            â”‚
    â”‚ â”‚   signal: 0.72 (scalar)          â”‚
    â”‚ â”‚   histogram: 0.13 (scalar)       â”‚
    â”‚ â”œâ”€ atr14: 1.20 (scalar)            â”‚
    â”‚ â”œâ”€ obv: 1245600 (scalar)           â”‚
    â”‚ â””â”€ vwap: 99.40 (scalar)            â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                 â”‚
          â–¼ (SUCCESS)
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚ Step 4: Detect Patterns            â”‚
    â”‚                                    â”‚
    â”‚ PatternService.detectAllPatterns() â”‚
    â”‚                                    â”‚
    â”‚ â†’ DetectedPattern[] [{             â”‚
    â”‚   pattern: "Hammer",               â”‚
    â”‚   confidence: 85,                  â”‚
    â”‚   isUptrend: true,                 â”‚
    â”‚   description: "..."               â”‚
    â”‚ }]                                 â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                 â”‚
          â–¼ (SUCCESS)
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚ Step 5: Generate Signal            â”‚
    â”‚                                    â”‚
    â”‚ ConfluenceEngine.generateSignal()  â”‚
    â”‚                                    â”‚
    â”‚ INPUT:                             â”‚
    â”‚  - ticker: "PETR4"                 â”‚
    â”‚  - candles: Candle[30]             â”‚
    â”‚  - indicators: IndicatorValues     â”‚
    â”‚  - patterns: DetectedPattern[]     â”‚
    â”‚                                    â”‚
    â”‚ PROCESS: (see next sections)       â”‚
    â”‚                                    â”‚
    â”‚ OUTPUT: TradingSignal {            â”‚
    â”‚  direction: "BUY",                 â”‚
    â”‚  confidence: 87,                   â”‚
    â”‚  strength: "STRONG",               â”‚
    â”‚  rationale: {...},                 â”‚
    â”‚  riskReward: {...},                â”‚
    â”‚  confluence: {...}                 â”‚
    â”‚ }                                  â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                 â”‚
          â–¼ (SUCCESS)
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚ Step 6: Filter by Confidence       â”‚
    â”‚                                    â”‚
    â”‚ if (signal.confidence >= 60)       â”‚
    â”‚   return full signal               â”‚
    â”‚ else                               â”‚
    â”‚   return signal + warning          â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                 â”‚
          â–¼ (SUCCESS)
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚ RESPONSE 200 OK                    â”‚
    â”‚                                    â”‚
    â”‚ {                                  â”‚
    â”‚   "ticker": "PETR4",               â”‚
    â”‚   "date": "2025-01-14T10:30:00Z",  â”‚
    â”‚   "signal": {...},                 â”‚
    â”‚   "summary": {...}                 â”‚
    â”‚ }                                  â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸ“ˆ Fluxo de Scoring de TendÃªncia {#fluxo-trend-score}

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ calculateTrendScore()            â”‚
â”‚                                  â”‚
â”‚ INPUT: indicators, candles       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                â”‚
                â–¼
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚ Initialize Score = 50         â”‚
    â”‚ (neutral baseline)            â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                    â”‚
                    â–¼
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚ CHECK 1: EMA21 vs EMA200     â”‚
    â”‚                              â”‚
    â”‚ ema21 = 99.20                â”‚
    â”‚ ema200 = 97.80               â”‚
    â”‚ emaDiff = 1.40               â”‚
    â”‚ emaPct = 1.43%               â”‚
    â”‚                              â”‚
    â”‚ if (emaPct > 0.5%)           â”‚
    â”‚   score += min(25, 1.43*2)   â”‚
    â”‚   score += 2.86 â†’ score=52.86â”‚
    â”‚ else if (emaPct < -0.5%)     â”‚
    â”‚   score -= min(25, |pct|*2)  â”‚
    â”‚ else                         â”‚
    â”‚   score unchanged            â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                    â”‚
                    â–¼
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚ CHECK 2: SMA50 vs SMA200     â”‚
    â”‚                              â”‚
    â”‚ sma50 = 99.50                â”‚
    â”‚ sma200 = 98.20               â”‚
    â”‚ smaDiff = 1.30               â”‚
    â”‚ smaPct = 1.32%               â”‚
    â”‚                              â”‚
    â”‚ if (smaPct > 0.5%)           â”‚
    â”‚   score += min(25, 1.32*2)   â”‚
    â”‚   score += 2.64 â†’ score=55.5 â”‚
    â”‚ [similar logic]              â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                    â”‚
                    â–¼
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚ CHECK 3: Price vs EMA200     â”‚
    â”‚                              â”‚
    â”‚ close = 102.50               â”‚
    â”‚ ema200 = 97.80               â”‚
    â”‚ priceDiff = 4.70             â”‚
    â”‚ pricePct = 4.81%             â”‚
    â”‚                              â”‚
    â”‚ if (pricePct > 2%)           â”‚
    â”‚   score += min(20, 4.81)     â”‚
    â”‚   score += 4.81 â†’ score=60.31â”‚
    â”‚ else if (pricePct < -2%)     â”‚
    â”‚   score -= min(20, |pct|)    â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                    â”‚
                    â–¼
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚ FINAL TREND SCORE            â”‚
    â”‚                              â”‚
    â”‚ score = 60.31                â”‚
    â”‚                              â”‚
    â”‚ INTERPRETATION:              â”‚
    â”‚ - score > 55 â†’ BULLISH       â”‚
    â”‚ - score < 45 â†’ BEARISH       â”‚
    â”‚ - 45-55 â†’ NEUTRAL            â”‚
    â”‚                              â”‚
    â”‚ Result: BULLISH (score=60)   â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
        â†“
    TREND_SCORE = 60 (used in final confidence)
```

---

## ğŸ¯ Fluxo de Scoring de Momentum {#fluxo-momentum-score}

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ calculateMomentumScore()          â”‚
â”‚                                  â”‚
â”‚ INPUT: indicators                â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                â”‚
                â–¼
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚ Initialize Score = 50         â”‚
    â”‚ (neutral baseline)            â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                    â”‚
                    â–¼
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚ CHECK 1: RSI(14) Analysis    â”‚
    â”‚                              â”‚
    â”‚ rsi14 = 65                   â”‚
    â”‚                              â”‚
    â”‚ RANGES:                      â”‚
    â”‚ - rsi < 30: OVERSOLD         â”‚
    â”‚   score += 67 â†’ score=117    â”‚
    â”‚ - rsi 30-50: BEARISH ZONE    â”‚
    â”‚   score -= 30 â†’ score=20     â”‚
    â”‚ - rsi 50-70: BULLISH ZONE    â”‚
    â”‚   score += 30 â†’ score=80     â”‚
    â”‚ - rsi > 70: OVERBOUGHT       â”‚
    â”‚   score -= 67 â†’ score=-17    â”‚
    â”‚                              â”‚
    â”‚ In our case:                 â”‚
    â”‚ rsi=65 (in 50-70 range)      â”‚
    â”‚ score += 30 â†’ score=80       â”‚
    â”‚                              â”‚
    â”‚ Additional:                  â”‚
    â”‚ if (rsi > 50)                â”‚
    â”‚   score += 15 (bullish bonus)â”‚
    â”‚ else if (rsi < 50)           â”‚
    â”‚   score -= 15 (bearish -ve)  â”‚
    â”‚                              â”‚
    â”‚ Final from RSI: score=95     â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                    â”‚
                    â–¼
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚ CHECK 2: MACD Analysis       â”‚
    â”‚                              â”‚
    â”‚ macd.macd = 0.85             â”‚
    â”‚ macd.signal = 0.72           â”‚
    â”‚ macd.histogram = 0.13        â”‚
    â”‚                              â”‚
    â”‚ if (histogram > 0)           â”‚
    â”‚   MACD is positive           â”‚
    â”‚   score += 20 â†’ score=115    â”‚
    â”‚                              â”‚
    â”‚ if (macd > signal)           â”‚
    â”‚   MACD above signal          â”‚
    â”‚   score += 10 â†’ score=125    â”‚
    â”‚                              â”‚
    â”‚ CONSTRAINT: cap at 100       â”‚
    â”‚ Final score = 100 (capped)   â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                    â”‚
                    â–¼
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚ Normalize by indicators used â”‚
    â”‚                              â”‚
    â”‚ We used 2 indicators (RSI+MACâ”‚
    â”‚ Raw score = 100 + 0 = 100    â”‚
    â”‚ (already at 100 cap)         â”‚
    â”‚                              â”‚
    â”‚ MOMENTUM_SCORE = 100         â”‚
    â”‚                              â”‚
    â”‚ INTERPRETATION:              â”‚
    â”‚ 80-100: Strong momentum      â”‚
    â”‚ 60-79: Moderate momentum     â”‚
    â”‚ 40-59: Weak momentum         â”‚
    â”‚ <40: Negative momentum       â”‚
    â”‚                              â”‚
    â”‚ Result: STRONG (100)         â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
        â†“
    MOMENTUM_SCORE = 100 (max positive)
```

---

## ğŸ”€ Fluxo de DeterminaÃ§Ã£o de DireÃ§Ã£o {#fluxo-direction}

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ determineDirection()                  â”‚
â”‚                                       â”‚
â”‚ INPUT: trendScore, momentumScore,     â”‚
â”‚        patternScore, patterns[], all  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                  â”‚
                  â–¼
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚ Count BULLISH Signals            â”‚
    â”‚                                  â”‚
    â”‚ bullishCount = 0                 â”‚
    â”‚                                  â”‚
    â”‚ if (trendScore > 55)             â”‚
    â”‚   bullishCount++ â†’ 1             â”‚
    â”‚                                  â”‚
    â”‚ if (momentumScore > 55)          â”‚
    â”‚   bullishCount++ â†’ 2             â”‚
    â”‚                                  â”‚
    â”‚ if (patternScore > 55)           â”‚
    â”‚   bullishCount++ â†’ 3             â”‚
    â”‚                                  â”‚
    â”‚ for each pattern in patterns[]   â”‚
    â”‚   if (pattern.isUptrend)         â”‚
    â”‚     bullishCount++ â†’ 4           â”‚
    â”‚                                  â”‚
    â”‚ Total BULLISH = 4 signals        â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                    â”‚
                    â–¼
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚ Count BEARISH Signals            â”‚
    â”‚                                  â”‚
    â”‚ bearishCount = 0                 â”‚
    â”‚ (similar logic, inverted)        â”‚
    â”‚                                  â”‚
    â”‚ Total BEARISH = 0 signals        â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                    â”‚
                    â–¼
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚ Decide Direction                 â”‚
    â”‚                                  â”‚
    â”‚ if (bullishCount >= 3)           â”‚
    â”‚   return "BUY"                   â”‚
    â”‚                                  â”‚
    â”‚ if (bearishCount >= 3)           â”‚
    â”‚   return "SELL"                  â”‚
    â”‚                                  â”‚
    â”‚ else                             â”‚
    â”‚   return "NEUTRAL"               â”‚
    â”‚                                  â”‚
    â”‚ In our case:                     â”‚
    â”‚ bullishCount = 4                 â”‚
    â”‚ bearishCount = 0                 â”‚
    â”‚ â†’ return "BUY"                   â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
        â†“
    DIRECTION = "BUY"
```

---

## ğŸ“Š Fluxo de Scan em Lote {#fluxo-scan-batch}

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ POST /api/signals/scan-all                 â”‚
â”‚                                            â”‚
â”‚ BODY: {                                    â”‚
â”‚   tickers: ["PETR4", "VALE3", "WEGE3"],    â”‚
â”‚   days: 30,                                â”‚
â”‚   minConfidence: 60,                       â”‚
â”‚   filterByStrength: "STRONG"               â”‚
â”‚ }                                          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
             â”‚
      â–¼ (validate)
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚ Validate Input                   â”‚
    â”‚                                  â”‚
    â”‚ - is array? YES                  â”‚
    â”‚ - length > 0? YES                â”‚
    â”‚ - length <= 50? YES              â”‚
    â”‚ - confidence 0-100? YES          â”‚
    â”‚ - strength valid? YES            â”‚
    â”‚                                  â”‚
    â”‚ â†’ PASS                           â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                    â”‚
              â–¼ (Process in parallel)
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚ Promise.all([                    â”‚
    â”‚   processTickerSignal("PETR4"),  â”‚
    â”‚   processTickerSignal("VALE3"),  â”‚
    â”‚   processTickerSignal("WEGE3")   â”‚
    â”‚ ])                               â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                    â”‚
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚           â”‚           â”‚
    â–¼ PETR4    â–¼ VALE3    â–¼ WEGE3
    
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚ processTickerSignal("PETR4")     â”‚
    â”‚                                 â”‚
    â”‚ try {                           â”‚
    â”‚   1. getHistoricalDaily("PETR4")â”‚
    â”‚   2. calculateAll(candles)      â”‚
    â”‚   3. adaptIndicators()          â”‚
    â”‚   4. detectAllPatterns()        â”‚
    â”‚   5. generateSignal()           â”‚
    â”‚                                 â”‚
    â”‚   signal = {                    â”‚
    â”‚     direction: "BUY",           â”‚
    â”‚     confidence: 87,             â”‚
    â”‚     strength: "STRONG",         â”‚
    â”‚     ...                         â”‚
    â”‚   }                             â”‚
    â”‚                                 â”‚
    â”‚   return {                      â”‚
    â”‚     ticker: "PETR4",            â”‚
    â”‚     signal: signal,             â”‚
    â”‚     confidence: 87,             â”‚
    â”‚     direction: "BUY"            â”‚
    â”‚   }                             â”‚
    â”‚ } catch (e) {                   â”‚
    â”‚   return {                      â”‚
    â”‚     ticker: "PETR4",            â”‚
    â”‚     error: "...",               â”‚
    â”‚     signal: null                â”‚
    â”‚   }                             â”‚
    â”‚ }                               â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
    
    Similar for VALE3 and WEGE3...
    
        â”‚           â”‚           â”‚
        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                    â”‚
                â–¼ (Merge results)
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚ signalResults = [                â”‚
    â”‚   {ticker: "PETR4", signal: ...},â”‚
    â”‚   {ticker: "VALE3", signal: ...},â”‚
    â”‚   {ticker: "WEGE3", signal: null}â”‚
    â”‚ ]                                â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                    â”‚
              â–¼ (Filter valid)
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚ validSignals = signalResults     â”‚
    â”‚   .filter(r => r.signal !== null)â”‚
    â”‚                                  â”‚
    â”‚ â†’ 2 signals (PETR4, VALE3)       â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                    â”‚
        â–¼ (Apply strength filter)
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚ if (filterByStrength === "STRONG")â”‚
    â”‚   validSignals = validSignals    â”‚
    â”‚     .filter(r =>                 â”‚
    â”‚       r.signal.strength ===      â”‚
    â”‚       "STRONG"                   â”‚
    â”‚     )                            â”‚
    â”‚                                  â”‚
    â”‚ â†’ 1 signal (PETR4, WEGE3 filtered)
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                    â”‚
              â–¼ (Sort by confidence)
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚ validSignals.sort((a, b) =>      â”‚
    â”‚   b.confidence - a.confidence    â”‚
    â”‚ )                                â”‚
    â”‚                                  â”‚
    â”‚ â†’ [PETR4(87), ...]               â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                    â”‚
              â–¼ (Calculate stats)
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚ const signals = validSignals     â”‚
    â”‚   .map(r => r.signal)            â”‚
    â”‚                                  â”‚
    â”‚ stats = ConfluenceEngine         â”‚
    â”‚   .calculateStats(signals)       â”‚
    â”‚                                  â”‚
    â”‚ stats = {                        â”‚
    â”‚   total: 1,                      â”‚
    â”‚   buyCount: 1,                   â”‚
    â”‚   sellCount: 0,                  â”‚
    â”‚   neutralCount: 0,               â”‚
    â”‚   avgConfidence: 87,             â”‚
    â”‚   strongCount: 1                 â”‚
    â”‚ }                                â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                    â”‚
                â–¼ (Response)
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚ RESPONSE 200 OK                  â”‚
    â”‚ {                                â”‚
    â”‚   requestedTickers: 3,           â”‚
    â”‚   signalsGenerated: 1,           â”‚
    â”‚   signals: [                     â”‚
    â”‚     {ticker: "PETR4", ...}       â”‚
    â”‚   ],                             â”‚
    â”‚   stats: {                       â”‚
    â”‚     total: 1,                    â”‚
    â”‚     buyCount: 1,                 â”‚
    â”‚     ...                          â”‚
    â”‚   },                             â”‚
    â”‚   filterApplied: {               â”‚
    â”‚     minConfidence: 60,           â”‚
    â”‚     filterByStrength: "STRONG"   â”‚
    â”‚   }                              â”‚
    â”‚ }                                â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸ’° Fluxo de Risco/Recompensa {#fluxo-risk-reward}

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ calculateRiskReward()                    â”‚
â”‚                                          â”‚
â”‚ INPUT: candle, direction, atr            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                 â”‚
                 â–¼
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚ FOR BUY SIGNAL                     â”‚
    â”‚                                    â”‚
    â”‚ candle = {                         â”‚
    â”‚   open: 101.50,                    â”‚
    â”‚   high: 103.80,                    â”‚
    â”‚   low: 100.20,                     â”‚
    â”‚   close: 102.50,                   â”‚
    â”‚   volume: 2500000                  â”‚
    â”‚ }                                  â”‚
    â”‚ atr = 1.50 (volatility)            â”‚
    â”‚                                    â”‚
    â”‚ STOP LOSS (Below):                 â”‚
    â”‚ SL = low - (1.5 Ã— ATR)             â”‚
    â”‚ SL = 100.20 - (1.5 Ã— 1.50)         â”‚
    â”‚ SL = 100.20 - 2.25                 â”‚
    â”‚ SL = 97.95                         â”‚
    â”‚                                    â”‚
    â”‚ TAKE PROFIT (Above):               â”‚
    â”‚ TP = close + (3 Ã— ATR)             â”‚
    â”‚ TP = 102.50 + (3 Ã— 1.50)           â”‚
    â”‚ TP = 102.50 + 4.50                 â”‚
    â”‚ TP = 107.00                        â”‚
    â”‚                                    â”‚
    â”‚ RISK/REWARD RATIO:                 â”‚
    â”‚ RR = (TP - Entry) / (Entry - SL)   â”‚
    â”‚ RR = (107.00 - 102.50) / (102.50 - 97.95)
    â”‚ RR = 4.50 / 4.55                   â”‚
    â”‚ RR = 0.99 â†’ 1:1 ratio              â”‚
    â”‚                                    â”‚
    â”‚ DISTANCE TO SL/TP:                 â”‚
    â”‚ toSL = SL - close = -4.55 (pips)   â”‚
    â”‚ toTP = TP - close = 4.50 (pips)    â”‚
    â”‚                                    â”‚
    â”‚ OUTPUT: {                          â”‚
    â”‚   stopLoss: 97.95,                 â”‚
    â”‚   takeProfit: 107.00,              â”‚
    â”‚   riskRewardRatio: 1.0,            â”‚
    â”‚   distance: {                      â”‚
    â”‚     toSL: -4.55,                   â”‚
    â”‚     toTP: 4.50                     â”‚
    â”‚   }                                â”‚
    â”‚ }                                  â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                 â”‚
                 â–¼
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚ FOR SELL SIGNAL (Inverse Logic)    â”‚
    â”‚                                    â”‚
    â”‚ STOP LOSS (Above):                 â”‚
    â”‚ SL = high + (1.5 Ã— ATR)            â”‚
    â”‚ SL = 103.80 + 2.25                 â”‚
    â”‚ SL = 106.05                        â”‚
    â”‚                                    â”‚
    â”‚ TAKE PROFIT (Below):               â”‚
    â”‚ TP = close - (3 Ã— ATR)             â”‚
    â”‚ TP = 102.50 - 4.50                 â”‚
    â”‚ TP = 98.00                         â”‚
    â”‚                                    â”‚
    â”‚ RISK/REWARD RATIO:                 â”‚
    â”‚ RR = (Entry - TP) / (SL - Entry)   â”‚
    â”‚ RR = (102.50 - 98.00) / (106.05 - 102.50)
    â”‚ RR = 4.50 / 3.55                   â”‚
    â”‚ RR = 1.27 â†’ 1.27:1 ratio           â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
        â†“
    Risk/Reward calculated for position sizing
```

---

## ğŸ”Œ Endpoints e IntegraÃ§Ãµes {#endpoints-integracao}

### Fluxo de IntegraÃ§Ã£o com MarketService

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ MarketService                    â”‚
â”‚ (Data Provider)                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                â”‚
                â–¼
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚ getHistoricalDaily()           â”‚
    â”‚ (cached in memory, DB failover)â”‚
    â”‚                                â”‚
    â”‚ INPUT: ticker, days            â”‚
    â”‚ OUTPUT: Candle[]               â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                    â”‚
              â–¼ (used by)
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚ IndicatorService               â”‚
    â”‚ (Calculate 7 indicators)       â”‚
    â”‚                                â”‚
    â”‚ Processes candles into arrays  â”‚
    â”‚ of IndicatorValue objects      â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                    â”‚
              â–¼ (used by)
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚ Type Adapter                   â”‚
    â”‚ adaptIndicatorsToConfluence()  â”‚
    â”‚                                â”‚
    â”‚ Converts arrays â†’ scalars      â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                    â”‚
              â–¼ (used by)
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚ ConfluenceEngine               â”‚
    â”‚ generateSignal()               â”‚
    â”‚                                â”‚
    â”‚ Combines indicators + patterns â”‚
    â”‚ â†’ Generates confidence scores  â”‚
    â”‚                                â”‚
    â”‚ Uses candles for:              â”‚
    â”‚ - Risk/reward calculations     â”‚
    â”‚ - Pattern detection context    â”‚
    â”‚ - OHLCV context                â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### Fluxo de IntegraÃ§Ã£o com PatternService

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ PatternService                   â”‚
â”‚ (Candlestick Analysis)           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                â”‚
                â–¼
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚ detectAllPatterns()            â”‚
    â”‚                                â”‚
    â”‚ INPUT: Candle[]                â”‚
    â”‚ OUTPUT: DetectedPattern[] {     â”‚
    â”‚   pattern: string,             â”‚
    â”‚   confidence: 0-100,           â”‚
    â”‚   isUptrend: boolean,          â”‚
    â”‚   description: string          â”‚
    â”‚ }                              â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                    â”‚
              â–¼ (used by)
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚ ConfluenceEngine               â”‚
    â”‚ generateSignal()               â”‚
    â”‚                                â”‚
    â”‚ Uses patterns for:             â”‚
    â”‚ - Pattern score calculation    â”‚
    â”‚ - Direction determination      â”‚
    â”‚ - Rationale generation         â”‚
    â”‚ - Component identification     â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸ” Fluxo de SeguranÃ§a

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ HTTP REQUEST                        â”‚
â”‚ POST /api/signals/generate/PETR4    â”‚
â”‚ Headers: Authorization: Bearer JWT  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
               â”‚
               â–¼
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚ authMiddleware               â”‚
    â”‚                              â”‚
    â”‚ 1. Extract token from header â”‚
    â”‚ 2. Verify JWT signature      â”‚
    â”‚ 3. Check token expiration    â”‚
    â”‚ 4. Validate user exists      â”‚
    â”‚ 5. Check user role (TRADER)  â”‚
    â”‚                              â”‚
    â”‚ if VALID:                    â”‚
    â”‚   req.user = {id, email, ...}â”‚
    â”‚   next()                     â”‚
    â”‚ else:                        â”‚
    â”‚   return 401 Unauthorized    â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                   â”‚
            â–¼ (VALID)
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚ Joi Validation               â”‚
    â”‚                              â”‚
    â”‚ - ticker: string (required)  â”‚
    â”‚ - days: int 1-365 (optional) â”‚
    â”‚ - minConfidence: int 0-100   â”‚
    â”‚                              â”‚
    â”‚ if INVALID:                  â”‚
    â”‚   return 400 Bad Request     â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                   â”‚
            â–¼ (VALID)
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚ Logging                      â”‚
    â”‚                              â”‚
    â”‚ logger.info('Signal gen...', â”‚
    â”‚   {ticker, days, user.id}    â”‚
    â”‚ )                            â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                   â”‚
            â–¼ (Process)
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚ Try-Catch Error Handling     â”‚
    â”‚                              â”‚
    â”‚ try {                        â”‚
    â”‚   ... (signal generation)    â”‚
    â”‚ } catch (error) {            â”‚
    â”‚   logger.error(...)          â”‚
    â”‚   return 500 Server Error    â”‚
    â”‚ }                            â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸ“‹ Resumo de Fluxos

| Fluxo | Entrada | Processamento | SaÃ­da |
|-------|---------|---------------|-------|
| **Generate** | ticker, days | Fetch â†’ Indicators â†’ Patterns â†’ Signal | TradingSignal |
| **Trend Score** | indicators, candles | EMA/SMA alignment | 0-100 |
| **Momentum** | indicators | RSI/MACD zones | 0-100 |
| **Direction** | scores, patterns | Count bullish/bearish | BUY/SELL/NEUTRAL |
| **Scan Batch** | tickers[], filters | Parallel processing | Signal[], stats |
| **Risk/Reward** | candle, direction, atr | SL/TP calculation | {SL, TP, RR, distances} |

---

*DocumentaÃ§Ã£o de Fluxos - Fase 2G*  
*Gerada em: 14 de Janeiro de 2025*
