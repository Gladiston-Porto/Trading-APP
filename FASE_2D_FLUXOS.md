# Fase 2d - Data Providers - FLUXOS

**Data**: 2024-01-20

---

## ğŸ”„ Fluxo Principal - getQuote()

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   Client: GET /api/market/quote/PETR4   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
           â”‚
           â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   Middleware: authMiddleware            â”‚
â”‚   - Valida JWT token                    â”‚
â”‚   - Extrai user do token                â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
           â”‚ âœ… Token vÃ¡lido
           â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   Middleware: rbacMiddleware            â”‚
â”‚   - Roles permitidas: [ADMIN, TRADER]   â”‚
â”‚   - Verifica role do usuÃ¡rio            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
           â”‚ âœ… Role OK
           â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   MarketService.getQuote('PETR4')       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
           â”‚
           â–¼
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚  PETR4       â”‚
    â”‚  Detecta B3? â”‚
    â”‚ 4 letras +   â”‚
    â”‚  1 nÃºmero    â”‚
    â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜
           â”‚ âœ… SIM (B3)
           â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   BrapiAdapter.getQuote('PETR4')        â”‚
â”‚   - URL: brapi.dev/api/quote/PETR4      â”‚
â”‚   - Timeout: 10s                        â”‚
â”‚   - Cache: 60s TTL                      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
           â”‚
        â”Œâ”€â”€â”´â”€â”€â”
        â–¼     â–¼
    âœ… OK   âŒ ERROR
        â”‚     â”‚
        â”‚     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚                â–¼
        â”‚     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚     â”‚ Log warning: Fallback   â”‚
        â”‚     â”‚ Tentando Yahoo...       â”‚
        â”‚     â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
        â”‚              â”‚
        â”‚              â–¼
        â”‚     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚     â”‚ YahooAdapter.getQuote   â”‚
        â”‚     â”‚ ('PETR4.SA')            â”‚
        â”‚     â”‚ - Adiciona sufixo .SA   â”‚
        â”‚     â”‚ - URL: query1.finance   â”‚
        â”‚     â”‚ - Timeout: 10s          â”‚
        â”‚     â”‚ - Cache: 60s TTL        â”‚
        â”‚     â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
        â”‚              â”‚
        â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜
               â”‚
               â–¼
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚  Format response   â”‚
        â”‚  - symbol          â”‚
        â”‚  - lastPrice       â”‚
        â”‚  - change          â”‚
        â”‚  - changePercent   â”‚
        â”‚  - volume          â”‚
        â”‚  - currency        â”‚
        â”‚  - source (BRAPI   â”‚
        â”‚    ou YAHOO)       â”‚
        â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                 â”‚
                 â–¼
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚  Log info:         â”‚
        â”‚  CotaÃ§Ã£o obtida    â”‚
        â”‚  (estruturada JSON)â”‚
        â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                 â”‚
                 â–¼
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚  Response 200 OK   â”‚
        â”‚  {                 â”‚
        â”‚    success: true,  â”‚
        â”‚    data: { ... }   â”‚
        â”‚  }                 â”‚
        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸ”„ Fluxo - getQuotes (mÃºltiplos)

```
POST /api/market/quotes
Body: { tickers: ['PETR4', 'VALE3', 'AAPL', 'MSFT', 'BTC-USD'] }

           â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  MarketService.getQuotes(tickers)    â”‚
â”‚  - Recebe array de 5 tickers         â”‚
â”‚  - Max 20 tickers por request        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
           â”‚
           â–¼
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚ Separar por tipo:        â”‚
    â”‚  B3: [PETR4, VALE3]      â”‚
    â”‚  EUA: [AAPL, MSFT]       â”‚
    â”‚  Crypto: [BTC-USD]       â”‚
    â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
           â”‚
         â”Œâ”€â”´â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
         â–¼   â–¼         â–¼
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚ BrapiAdapter
    â”‚ .getQuotes â”‚ â”‚YahooAdapterâ”‚ â”‚YahooAdapterâ”‚
    â”‚ (['PETR4', â”‚ â”‚.getQuotes  â”‚ â”‚.getQuote   â”‚
    â”‚  'VALE3']) â”‚ â”‚(['AAPL',   â”‚ â”‚('BTC-USD') â”‚
    â”‚            â”‚ â”‚ 'MSFT'])   â”‚ â”‚            â”‚
    â”‚ Paralelo:  â”‚ â”‚            â”‚ â”‚ Paralelo:  â”‚
    â”‚ max 5 conc â”‚ â”‚Paralelo:   â”‚ â”‚ max 5 conc â”‚
    â””â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜ â”‚ max 5 conc â”‚ â””â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜
          â”‚        â””â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜       â”‚
          â”‚              â”‚              â”‚
          â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                     â”‚
                     â–¼
          â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
          â”‚ Merge Map results:       â”‚
          â”‚ {                        â”‚
          â”‚   'PETR4': {brapi},      â”‚
          â”‚   'VALE3': {brapi},      â”‚
          â”‚   'AAPL': {yahoo},       â”‚
          â”‚   'MSFT': {yahoo},       â”‚
          â”‚   'BTC-USD': {yahoo}     â”‚
          â”‚ }                        â”‚
          â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                     â”‚
                     â–¼
          â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
          â”‚ Log info:                â”‚
          â”‚ "5 quotes obtidas"       â”‚
          â”‚ (JSON estruturado)       â”‚
          â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                     â”‚
                     â–¼
          Response 200: count: 5
```

---

## ğŸ“Š Fluxo - getHistoricalDaily (com cache Prisma)

```
GET /api/market/historical/PETR4?days=365

           â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ MarketService.getHistoricalDaily()       â”‚
â”‚ ticker='PETR4', days=365                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
           â”‚
           â–¼
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚ Checar DB Prisma:          â”‚
    â”‚ SELECT * FROM Candle       â”‚
    â”‚ WHERE symbol='PETR4'       â”‚
    â”‚ ORDER BY date DESC         â”‚
    â”‚ LIMIT 365                  â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
             â”‚
        â”Œâ”€â”€â”€â”€â”´â”€â”€â”€â”€â”
        â–¼         â–¼
    HIT      MISS
    (52%)    (48%)
    â”‚         â”‚
    â–¼         â–¼
   âœ…        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
   Use      â”‚ Cache < 80% ?              â”‚
   DB       â”‚ 52 candles < 292 (80%)     â”‚
   â”‚        â”‚ SIM, precisa de API        â”‚
   â”‚        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
   â”‚                    â”‚ âœ… SIM
   â”‚                    â–¼
   â”‚         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
   â”‚         â”‚ YahooAdapter              â”‚
   â”‚         â”‚ .getHistoricalDaily()     â”‚
   â”‚         â”‚ ('PETR4', 365)            â”‚
   â”‚         â”‚ - Fetch Ãºltimos 365 dias  â”‚
   â”‚         â”‚ - Parse OHLCV             â”‚
   â”‚         â”‚ - Timeout: 15s            â”‚
   â”‚         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
   â”‚                     â”‚
   â”‚                     â–¼
   â”‚         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
   â”‚         â”‚ Filter duplicatas:        â”‚
   â”‚         â”‚ SELECT DISTINCT           â”‚
   â”‚         â”‚ FROM Candle               â”‚
   â”‚         â”‚ WHERE symbol='PETR4'      â”‚
   â”‚         â”‚ AND date IN (new_dates)   â”‚
   â”‚         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
   â”‚                     â”‚
   â”‚                     â–¼
   â”‚         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
   â”‚         â”‚ INSERT new candles:       â”‚
   â”‚         â”‚ Prisma.candle.createMany()â”‚
   â”‚         â”‚ [365 registros]           â”‚
   â”‚         â”‚ (batch insert)            â”‚
   â”‚         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
   â”‚                     â”‚
   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
              â”‚
              â–¼
   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
   â”‚ Query final:             â”‚
   â”‚ SELECT * FROM Candle     â”‚
   â”‚ WHERE symbol='PETR4'     â”‚
   â”‚ ORDER BY date DESC       â”‚
   â”‚ LIMIT 365                â”‚
   â”‚ [Agora com 365 candles]  â”‚
   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
              â”‚
              â–¼
   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
   â”‚ Format OHLCV:            â”‚
   â”‚ { date, open, high, low, â”‚
   â”‚   close, volume }        â”‚
   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
              â”‚
              â–¼
   Response 200: count: 365
```

**Cache Hit Timeline:**
```
Day 1:   0 candles in DB    â†’ Fetch 365 from API â†’ Store in DB (100% miss)
Day 2:   365 candles in DB  â†’ 100% hit, uso DB   (0% miss)
Day 3:   365 candles in DB  â†’ 100% hit, uso DB   (0% miss)
...
Day 366: 365 candles in DB  â†’ 100% hit, uso DB   (0% miss)
Day 367: 366 candles in DB  â†’ 100% hit, uso DB   (0% miss)
```

**Resultado**: ApÃ³s Day 1, todas as requisiÃ§Ãµes de histÃ³rico sÃ£o <10ms (DB query)

---

## ğŸ¥ Fluxo - health()

```
GET /api/market/health
Authorization: Bearer <token_admin>

           â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ MarketService.health()       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
           â”‚
        â”Œâ”€â”€â”´â”€â”€â”
        â–¼     â–¼
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚ BrapiAdapter        â”‚
    â”‚ .health()           â”‚
    â”‚ - Ping brapi.dev    â”‚
    â”‚ - Timeout: 5s       â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
             â”‚
        â”Œâ”€â”€â”€â”€â”´â”€â”€â”€â”€â”
        â–¼         â–¼
       âœ…        âŒ
       UP        DOWN
       â”‚         â”‚
    â”Œâ”€â”€â”´â”€â”€â”
    â–¼     â–¼
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚ YahooAdapter        â”‚
    â”‚ .health()           â”‚
    â”‚ - Ping query1       â”‚
    â”‚ - Timeout: 5s       â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
             â”‚
        â”Œâ”€â”€â”€â”€â”´â”€â”€â”€â”€â”
        â–¼         â–¼
       âœ…        âŒ
       UP        DOWN
       â”‚         â”‚
       â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”˜
            â–¼
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚ Determine status:        â”‚
    â”‚ - brapi: âœ… UP           â”‚
    â”‚ - yahoo: âœ… UP           â”‚
    â”‚ - overall: âœ… OK         â”‚
    â”‚                          â”‚
    â”‚ OR                       â”‚
    â”‚                          â”‚
    â”‚ - brapi: âŒ DOWN         â”‚
    â”‚ - yahoo: âœ… UP           â”‚
    â”‚ - overall: âš ï¸ DEGRADED   â”‚
    â”‚                          â”‚
    â”‚ OR                       â”‚
    â”‚                          â”‚
    â”‚ - brapi: âŒ DOWN         â”‚
    â”‚ - yahoo: âŒ DOWN         â”‚
    â”‚ - overall: ğŸ”´ CRITICAL   â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
               â”‚
               â–¼
    Response 200/503
    {
      success: true/false,
      data: {
        brapi: "âœ… UP",
        yahoo: "âœ… UP",
        overall: "âœ… OK"
      }
    }
```

---

## ğŸ”€ Fluxo de DetecÃ§Ã£o B3 vs EUA

```
Input: ticker string

        â–¼
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚ Regex check:       â”‚
    â”‚ /^[A-Z]{4}\d$/     â”‚
    â”‚                    â”‚
    â”‚ Exemplos:          â”‚
    â”‚ PETR4  âœ… B3       â”‚
    â”‚ VALE3  âœ… B3       â”‚
    â”‚ BBDC4  âœ… B3       â”‚
    â”‚ AAPL   âŒ nÃ£o Ã©    â”‚
    â”‚ BTC-USDâŒ nÃ£o Ã©    â”‚
    â”‚ PETR4.SAâŒ tem .   â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
             â”‚
        â”Œâ”€â”€â”€â”€â”´â”€â”€â”€â”€â”
        â–¼         â–¼
       SIM        NÃƒO
      (B3)       (EUA/Global)
       â”‚           â”‚
       â–¼           â–¼
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚ BrapiAdapter        â”‚ YahooAdapter
    â”‚ (direto PETR4)      â”‚ (direto AAPL)
    â”‚ OU                  â”‚ OU
    â”‚ Fallback:           â”‚ Yahoo cripto
    â”‚ YahooAdapter        â”‚ (BTC-USD)
    â”‚ (PETR4.SA)          â”‚ OU
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ Yahoo Ã­ndice
             â”‚              (^BVSP)
             â–¼              â”‚
        Return Quote        â–¼
                        Return Quote
```

**LÃ³gica no cÃ³digo:**
```typescript
const isB3 = !ticker.includes('.') && ticker.match(/^[A-Z]{4}\d$/);

if (isB3) {
  // Tentar Brapi, fallback Yahoo .SA
  return await getQuoteB3(ticker);
} else {
  // Direto Yahoo
  return await getQuoteUSA(ticker);
}
```

---

## âŒ Fluxo de Error Handling

```
Request: /api/market/quote/INVALID

           â–¼
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚ Validation Joi   â”‚
    â”‚ ticker regex:    â”‚
    â”‚ /^[A-Z0-9.^-]+$/ â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
             â”‚
        â”Œâ”€â”€â”€â”€â”´â”€â”€â”€â”€â”
        â–¼         â–¼
      PASS      FAIL
      â”‚         â”‚
      â”‚         â–¼
      â”‚    Response 400
      â”‚    {
      â”‚      success: false,
      â”‚      error: "VALIDATION_ERROR",
      â”‚      details: "..."
      â”‚    }
      â”‚
      â–¼
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚ BrapiAdapter       â”‚
    â”‚ .getQuote('INVALID')
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
             â”‚
        â”Œâ”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”
        â–¼             â–¼
      404          TIMEOUT
      â”‚            â”‚
      â–¼            â–¼
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚ Fallback: Yahoo      â”‚
    â”‚ .getQuote('INVALID') â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
             â”‚
        â”Œâ”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”
        â–¼             â–¼
      404          TIMEOUT
      â”‚            â”‚
      â–¼            â–¼
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚ Both failed               â”‚
    â”‚ Log error (structured)    â”‚
    â”‚ Count retries             â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
             â”‚
             â–¼
    Response 500
    {
      success: false,
      error: "MARKET_ERROR",
      message: "Falha ao obter cotaÃ§Ã£o",
      details: "Brapi: 404 | Yahoo: 404"
    }
```

---

## ğŸ” Fluxo com RBAC

```
Request: GET /api/market/historical/PETR4

           â–¼
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚ authMiddleware           â”‚
    â”‚ Valida JWT token         â”‚
    â”‚ Extrai userId, role      â”‚
    â”‚ user = {                 â”‚
    â”‚   id: 123,               â”‚
    â”‚   role: 'VIEW'           â”‚
    â”‚ }                        â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
             â”‚ âœ… Token OK
             â–¼
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚ rbacMiddleware           â”‚
    â”‚ (['ADMIN', 'TRADER'])    â”‚
    â”‚                          â”‚
    â”‚ Requeridos: ADMIN/TRADER â”‚
    â”‚ UsuÃ¡rio: VIEW            â”‚
    â”‚                          â”‚
    â”‚ 'VIEW' nÃ£o estÃ¡ em       â”‚
    â”‚ ['ADMIN', 'TRADER']      â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
             â”‚ âŒ NÃ£o autorizado
             â–¼
    Response 403 FORBIDDEN
    {
      success: false,
      error: "RBAC_ERROR",
      message: "Acesso negado para role VIEW"
    }

---

SE user.role = 'TRADER':

    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚ rbacMiddleware check     â”‚
    â”‚ 'TRADER' estÃ¡ em         â”‚
    â”‚ ['ADMIN', 'TRADER'] âœ…   â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
             â”‚ âœ… Autorizado
             â–¼
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚ Proceder com request     â”‚
    â”‚ MarketService.getHistory â”‚
    â”‚ (...)                    â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
             â”‚
             â–¼
    Response 200 OK
```

**Endpoints e seus RBAC:**

| Endpoint | GET/POST | RBAC |
|----------|----------|------|
| /quote/:ticker | GET | ['ADMIN','TRADER','VIEW'] |
| /quotes | POST | ['ADMIN','TRADER','VIEW'] |
| /historical/:ticker | GET | ['ADMIN','TRADER'] |
| /health | GET | ['ADMIN'] |
| /cache/clear | POST | ['ADMIN'] |

---

## ğŸ“± Fluxo Completo: UsuÃ¡rio novo

```
[NOVO USUÃRIO]

    1. POST /api/auth/register
       { email, password, name }
           â–¼
       AuthService.register()
           â–¼
       Cria User (role: default 'VIEW')
           â–¼
       Response: { token_access, token_refresh }

    2. GET /api/market/quote/PETR4
       { Authorization: Bearer <access_token> }
           â–¼
       authMiddleware âœ… (token vÃ¡lido)
           â–¼
       rbacMiddleware(['ADMIN','TRADER','VIEW']) âœ… (VIEW estÃ¡ permitida)
           â–¼
       MarketService.getQuote('PETR4')
           â–¼
       BrapiAdapter.getQuote('PETR4') âœ…
           â–¼
       Response 200: { PETR4 quote data }

    3. GET /api/market/historical/PETR4
       { Authorization: Bearer <access_token> }
           â–¼
       authMiddleware âœ…
           â–¼
       rbacMiddleware(['ADMIN','TRADER']) âŒ (VIEW nÃ£o permitida)
           â–¼
       Response 403 FORBIDDEN

    4. UPDATE role â†’ 'TRADER' (por admin)
       
    5. GET /api/market/historical/PETR4
       { Authorization: Bearer <access_token> }
           â–¼
       authMiddleware âœ…
           â–¼
       rbacMiddleware(['ADMIN','TRADER']) âœ… (TRADER permitida)
           â–¼
       MarketService.getHistoricalDaily('PETR4', 365)
           â–¼
       Query Prisma Candle (primeiro dia: vazio)
           â–¼
       Fallback: YahooAdapter.getHistoricalDaily('PETR4', 365)
           â–¼
       Insere 365 candles em Prisma
           â–¼
       Response 200: { 365 candles }
```

---

## ğŸ”„ Ciclo de Vida de 1 semana

```
|  Dia 1  | Dia 2-7 | 
|---------|---------|
| Cold    | Warm    |
| Cache   | Cache   |
|---------|---------|

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ DIA 1: COLD START                      â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ RequisiÃ§Ãµes: GET /historical/PETR4     â”‚
â”‚                                        â”‚
â”‚ Em memÃ³ria (60s TTL):     âŒ Vazio     â”‚
â”‚ BD Prisma Candle:         âŒ Vazio     â”‚
â”‚                                        â”‚
â”‚ Fluxo:                                 â”‚
â”‚ 1. Query Prisma        â†’ 0 candles     â”‚
â”‚ 2. Fetch Yahoo         â†’ 365 candles   â”‚
â”‚ 3. Insere Prisma       â†’ 365 candles   â”‚
â”‚ 4. Return 365          â†’ cliente       â”‚
â”‚                                        â”‚
â”‚ Tempo total: ~2000ms (network)         â”‚
â”‚ Num requisiÃ§Ãµes API: 1 (Yahoo)         â”‚
â”‚ Num requisiÃ§Ãµes DB: 2 (select+insert)  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ DIA 2-7: WARM CACHE                    â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ RequisiÃ§Ãµes: GET /historical/PETR4     â”‚
â”‚ (mesma requisiÃ§Ã£o, mesmo ticker)       â”‚
â”‚                                        â”‚
â”‚ Em memÃ³ria (60s): pode estar âœ…         â”‚
â”‚ BD Prisma Candle: 365 candles âœ…       â”‚
â”‚                                        â”‚
â”‚ Fluxo (cache hit):                     â”‚
â”‚ 1. Query Prisma        â†’ 365 candles   â”‚
â”‚ 2. Calcula %           â†’ 100% (OK)     â”‚
â”‚ 3. Return 365          â†’ cliente       â”‚
â”‚ 4. Sem chamada API!                    â”‚
â”‚                                        â”‚
â”‚ Tempo total: ~50ms (DB query)          â”‚
â”‚ Num requisiÃ§Ãµes API: 0 (cache hit!)    â”‚
â”‚ Num requisiÃ§Ãµes DB: 1 (select)         â”‚
â”‚                                        â”‚
â”‚ ECONOMIA: 2000ms â†’ 50ms (40x rÃ¡pido)   â”‚
â”‚ ECONOMIA: $1 API â†’ $0 (40x mais barato)â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ INCREMENTO NOVO DIA:                   â”‚
â”‚ (PrÃ³ximo ticker novo, ex: VALE3)       â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ Mesma sequÃªncia que Dia 1              â”‚
â”‚ Cold start para novo ticker            â”‚
â”‚                                        â”‚
â”‚ Mas tickers antigos (PETR4, etc)       â”‚
â”‚ continuam em cache Prisma âœ…            â”‚
â”‚                                        â”‚
â”‚ Crescimento BD:                        â”‚
â”‚ PETR4: 365 candles                     â”‚
â”‚ VALE3: 365 candles (novo)              â”‚
â”‚ AAPL:  365 candles (novo)              â”‚
â”‚ ...                                    â”‚
â”‚                                        â”‚
â”‚ ApÃ³s 1 mÃªs: ~12,000 candles no BD      â”‚
â”‚ (apenas 1 vez por ticker)              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

**Status**: âœ… FLUXOS DOCUMENTADOS  
**Ãšltima atualizaÃ§Ã£o**: 2024-01-20
